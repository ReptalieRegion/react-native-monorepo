version: 2.1
jobs:
    react-native-test:
        docker:
            - image: cimg/node:18.8
        steps:
            - checkout
            - restore_cache:
                  key: yarn-v1-{{ checksum "yarn.lock" }}-{{ arch }}
            - restore_cache:
                  key: node-v1-{{ checksum "package.json" }}-{{ arch }}
            - run: yarn install
            - run: yarn test
            - run: yarn tsc
            - save_cache:
                  key: yarn-v1-{{ checksum "yarn.lock" }}-{{ arch }}
                  paths:
                      - ~/.cache/yarn
            - save_cache:
                  key: node-v1-{{ checksum "package.json" }}-{{ arch }}
                  paths:
                      - ~/node_modules

    macos-build-and-deploy:
        macos:
            xcode: 14.2.0
        environment:
            FL_OUTPUT_DIR: output
            FASTLANE_LANE: beta
        steps:
            - checkout
            - working_directory: ./apps/crawl
            - restore_cache:
                  key: yarn-v1-{{ checksum "yarn.lock" }}-{{ arch }}
            - restore_cache:
                  key: node-v1-{{ checksum "package.json" }}-{{ arch }}
            - run: yarn install
            - save_cache:
                  key: yarn-v1-{{ checksum "yarn.lock" }}-{{ arch }}
                  paths:
                      - ~/.cache/yarn
            - save_cache:
                  key: node-v1-{{ checksum "package.json" }}-{{ arch }}
                  paths:
                      - ~/node_modules
            - restore_cache:
                  key: bundle-v1-{{ checksum "ios/Gemfile.lock" }}-{{ arch }}
            - restore_cache:
                  key: pods-v1-{{ checksum "ios/Podfile.lock" }}-{{ arch }}
            - run:
                  command: pod install
                  working_directory: ios
            - run:
                  command: bundle install
                  working_directory: ios
            - save_cache:
                  key: bundle-v1-{{ checksum "ios/Gemfile.lock" }}-{{ arch }}
                  paths:
                      - vendor/bundle
            - save_cache:
                  key: pods-v1-{{ checksum "ios/Podfile.lock" }}-{{ arch }}
                  paths:
                      - ios/Pods
            - run:
                  name: Fastlane deploy TestFlight
                  command: yarn deploy:dev 1.1.23
            - store_artifacts:
                  path: output
            - store_test_results:
                  path: output/scan

workflows:
    build-test-testflight:
        jobs:
            - react-native-test
            - macos-build-and-deploy
